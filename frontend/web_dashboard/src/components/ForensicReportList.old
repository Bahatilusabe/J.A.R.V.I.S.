/**
 * ForensicReportList - Advanced Cutting-Edge Forensics Dashboard
 *
 * A professional-grade forensics analysis interface with:
 * - Real-time incident timeline visualization
 * - Interactive artifact/evidence browser with chain-of-custody
 * - Blockchain signature verification with post-quantum cryptography (Dilithium)
 * - Multi-source forensics data aggregation (LedgerManager, Web3, Hyperledger Fabric)
 * - Advanced filtering, search, and export capabilities
 * - Live threat detection and automated evidence collection
 */

import React, { useState, useEffect, useCallback } from 'react'
import type {
  ForensicReportSummary,
  IncidentSeverity,
  IncidentStatus,
  ForensicReportFilter,
  ForensicReport,
  ForensicFinding,
  EvidenceItem,
  TimelineEntry,
} from '../types/forensics.types'

// Import sub-components
import ForensicsTimeline from './ForensicsTimeline.tsx'
import EvidenceBrowser from './EvidenceBrowser.tsx'

// ============================================================================
// TYPES & INTERFACES
// ============================================================================

type ViewMode = 'timeline' | 'evidence' | 'findings' | 'verification'
type SortField = 'timestamp' | 'severity' | 'type' | 'size'
type SortOrder = 'asc' | 'desc'

interface ForensicsState {
  report: ForensicReport | null
  isLoading: boolean
  error: string | null
  selectedEvidence: EvidenceItem | null
  selectedFinding: ForensicFinding | null
  filteredTimeline: TimelineEntry[]
  filteredFindings: ForensicFinding[]
  filteredEvidence: EvidenceItem[]
  viewMode: ViewMode
  sortField: SortField
  sortOrder: SortOrder
  searchQuery: string
  severityFilter: string[]
  typeFilter: string[]
  verificationStatus: 'pending' | 'verified' | 'failed' | null
}

// ============================================================================
// SEVERITY STYLING
// ============================================================================

const getSeverityClass = (severity: IncidentSeverity): string => {
  const map: Record<IncidentSeverity, string> = {
    low: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
    medium: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
    high: 'bg-orange-500/20 text-orange-400 border-orange-500/30',
    critical: 'bg-red-500/20 text-red-400 border-red-500/30',
    catastrophic: 'bg-pink-500/20 text-pink-300 border-pink-500/30',
  }
  return map[severity]
}

const getSeverityLabel = (severity: IncidentSeverity): string => {
  const labels: Record<IncidentSeverity, string> = {
    low: 'Low',
    medium: 'Medium',
    high: 'High',
    critical: 'Critical',
    catastrophic: 'Catastrophic',
  };
  return labels[severity];
};

const getStatusClass = (status: IncidentStatus): string => {
  const map: Record<IncidentStatus, string> = {
    detected: 'bg-blue-500/20 text-blue-400',
    investigating: 'bg-amber-500/20 text-amber-400',
    contained: 'bg-violet-500/20 text-violet-400',
    resolved: 'bg-emerald-500/20 text-emerald-400',
    archived: 'bg-slate-700/50 text-slate-300',
  }
  return map[status]
}

const getStatusLabel = (status: IncidentStatus): string => {
  const labels: Record<IncidentStatus, string> = {
    detected: 'Detected',
    investigating: 'Investigating',
    contained: 'Contained',
    resolved: 'Resolved',
    archived: 'Archived',
  };
  return labels[status];
};

// ============================================================================
// COMPONENT PROPS & INTERFACE
// ============================================================================

interface ForensicReportListProps {
  reports: ForensicReportSummary[];
  isLoading?: boolean;
  onSelectReport: (reportId: string) => void;
  onDownloadReport?: (reportId: string) => void;
  onFilter?: (filter: ForensicReportFilter) => void;
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export const ForensicReportList: React.FC<ForensicReportListProps> = ({
  reports,
  isLoading = false,
  onSelectReport,
  onDownloadReport,
  onFilter,
}) => {
  // =========================================================================
  // STATE
  // =========================================================================

  const [searchText, setSearchText] = useState<string>('');
  const [selectedStatuses, setSelectedStatuses] = useState<IncidentStatus[]>([]);
  const [selectedSeverities, setSelectedSeverities] = useState<IncidentSeverity[]>([]);
  const [dateRange, setDateRange] = useState<{ start: string; end: string }>({
    start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    end: new Date().toISOString().split('T')[0],
  });
  const [sortBy, setSortBy] = useState<'date' | 'severity' | 'status'>('date');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  // keep the setter name prefixed with _ to satisfy the lint rule when unused
  const [expandedRowId, _setExpandedRowId] = useState<string | null>(null);

  // =========================================================================
  // FILTER & SORT LOGIC
  // =========================================================================

  const filteredAndSortedReports = useMemo(() => {
    let filtered = [...reports];

    // Text search
    if (searchText) {
      const lowerSearch = searchText.toLowerCase();
      filtered = filtered.filter(
        (report) =>
          report.id.toLowerCase().includes(lowerSearch) ||
          report.incidentId.toLowerCase().includes(lowerSearch) ||
          report.title.toLowerCase().includes(lowerSearch) ||
          report.generatedBy.toLowerCase().includes(lowerSearch)
      );
    }

    // Status filter
    if (selectedStatuses.length > 0) {
      filtered = filtered.filter((report) => selectedStatuses.includes(report.status));
    }

    // Severity filter
    if (selectedSeverities.length > 0) {
      filtered = filtered.filter((report) => selectedSeverities.includes(report.severity));
    }

    // Date range filter
    if (dateRange.start && dateRange.end) {
      const startDate = new Date(dateRange.start).getTime();
      const endDate = new Date(dateRange.end).getTime() + 86400000; // Include entire end date
      filtered = filtered.filter((report) => {
        const reportDate = new Date(report.detectedAt).getTime();
        return reportDate >= startDate && reportDate <= endDate;
      });
    }

    // Sorting
    filtered.sort((a, b) => {
      let comparison = 0;

      if (sortBy === 'date') {
        comparison = new Date(a.detectedAt).getTime() - new Date(b.detectedAt).getTime();
      } else if (sortBy === 'severity') {
        const severityOrder: Record<IncidentSeverity, number> = {
          catastrophic: 5,
          critical: 4,
          high: 3,
          medium: 2,
          low: 1,
        };
        comparison = severityOrder[a.severity] - severityOrder[b.severity];
      } else if (sortBy === 'status') {
        comparison = a.status.localeCompare(b.status);
      }

      return sortOrder === 'asc' ? comparison : -comparison;
    });

    return filtered;
  }, [reports, searchText, selectedStatuses, selectedSeverities, dateRange, sortBy, sortOrder]);

  // =========================================================================
  // EVENT HANDLERS
  // =========================================================================

  const handleToggleStatus = useCallback((status: IncidentStatus) => {
    setSelectedStatuses((prev) =>
      prev.includes(status) ? prev.filter((s) => s !== status) : [...prev, status]
    );
  }, []);

  const handleToggleSeverity = useCallback((severity: IncidentSeverity) => {
    setSelectedSeverities((prev) =>
      prev.includes(severity)
        ? prev.filter((s) => s !== severity)
        : [...prev, severity]
    );
  }, []);

  const handleApplyFilters = useCallback(() => {
    if (onFilter) {
      onFilter({
        searchText: searchText || undefined,
        status: selectedStatuses.length > 0 ? selectedStatuses : undefined,
        severity: selectedSeverities.length > 0 ? selectedSeverities : undefined,
        dateRange: dateRange.start && dateRange.end ? dateRange : undefined,
      });
    }
  }, [searchText, selectedStatuses, selectedSeverities, dateRange, onFilter]);

  const handleClearFilters = useCallback(() => {
    setSearchText('');
    setSelectedStatuses([]);
    setSelectedSeverities([]);
    setDateRange({
      start: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      end: new Date().toISOString().split('T')[0],
    });
    if (onFilter) {
      onFilter({});
    }
  }, [onFilter]);

  // =========================================================================
  // HELPER FUNCTIONS
  // =========================================================================

  const formatDate = (dateString: string): string => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const getVerificationBadge = (isValid: boolean) => (
    <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-sm font-semibold ${isValid ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>
      {isValid ? '✓ Verified' : '✗ Unverified'}
    </span>
  )

  // =========================================================================
  // RENDER
  // =========================================================================
  return (
    <div className="flex flex-col gap-5 h-full">
      <div className="p-4 bg-gray-50 border border-gray-200 rounded-md">
        <div className="flex flex-col gap-4">
          <div className="flex gap-3 items-center">
            <label htmlFor="forensics-search" className="font-semibold min-w-[80px]">Search:</label>
            <input
              id="forensics-search"
              type="text"
              aria-label="Search forensic reports"
              value={searchText}
              onChange={(e) => setSearchText(e.target.value)}
              placeholder="Report ID, incident ID, title..."
              className="flex-1 px-3 py-2 border border-gray-300 rounded text-sm"
            />
          </div>

          <div className="flex gap-3 items-start">
            <label className="font-semibold min-w-[80px] pt-1">Status:</label>
            <div className="flex gap-2 flex-wrap">
              {(['detected', 'investigating', 'contained', 'resolved', 'archived'] as IncidentStatus[]).map(
                (status) => {
                  const selected = selectedStatuses.includes(status)
                  return (
                    <button
                      key={status}
                      onClick={() => handleToggleStatus(status)}
                      className={`px-3 py-1 rounded-full text-sm font-semibold transition ${
                        selected ? `${getStatusClass(status)} text-white` : 'border border-gray-200 text-gray-600 bg-white'
                      }`}
                    >
                      {getStatusLabel(status)}
                    </button>
                  )
                }
              )}
            </div>
          </div>

          <div className="flex gap-3 items-start">
            <label className="font-semibold min-w-[80px] pt-1">Severity:</label>
            <div className="flex gap-2 flex-wrap">
              {(['catastrophic', 'critical', 'high', 'medium', 'low'] as IncidentSeverity[]).map((severity) => {
                const selected = selectedSeverities.includes(severity)
                return (
                  <button
                    key={severity}
                    onClick={() => handleToggleSeverity(severity)}
                    className={`px-3 py-1 rounded-full text-sm font-semibold transition ${
                      selected ? `${getSeverityClass(severity)} text-white` : 'border border-gray-200 text-gray-600 bg-white'
                    }`}
                  >
                    {getSeverityLabel(severity)}
                  </button>
                )
              })}
            </div>
          </div>

          <div className="flex gap-3 items-center">
            <label htmlFor="forensics-start" className="font-semibold min-w-[80px]">Date Range:</label>
            <input
              id="forensics-start"
              type="date"
              aria-label="Start date"
              value={dateRange.start}
              onChange={(e) => setDateRange({ ...dateRange, start: e.target.value })}
              className="px-3 py-2 border border-gray-300 rounded text-sm"
            />
            <span className="text-gray-500">to</span>
            <input
              id="forensics-end"
              type="date"
              aria-label="End date"
              value={dateRange.end}
              onChange={(e) => setDateRange({ ...dateRange, end: e.target.value })}
              className="px-3 py-2 border border-gray-300 rounded text-sm"
            />
          </div>

          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <label htmlFor="forensics-sort" className="font-semibold min-w-[60px]">Sort:</label>
              <select
                id="forensics-sort"
                aria-label="Sort reports"
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value as 'date' | 'severity' | 'status')}
                className="px-3 py-1 border border-gray-300 rounded text-sm"
              >
                <option value="date">Date</option>
                <option value="severity">Severity</option>
                <option value="status">Status</option>
              </select>
              <button
                onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                className="px-3 py-1 border border-gray-300 rounded text-sm font-semibold"
                title={`Sort ${sortOrder === 'asc' ? 'ascending' : 'descending'}`}
              >
                {sortOrder === 'asc' ? '↑' : '↓'}
              </button>
            </div>
            <div className="flex gap-2">
              <button onClick={handleApplyFilters} className="px-4 py-2 bg-blue-600 text-white rounded font-semibold">Apply Filters</button>
              <button onClick={handleClearFilters} className="px-4 py-2 bg-gray-200 text-gray-700 rounded font-semibold">Clear Filters</button>
            </div>
          </div>
        </div>
      </div>

      <div className="flex-1 overflow-auto rounded border border-gray-200 bg-white">
        {isLoading ? (
          <div className="p-10 text-center text-gray-500 flex items-center justify-center h-full">
            <span>Loading forensic reports...</span>
          </div>
        ) : filteredAndSortedReports.length === 0 ? (
          <div className="p-10 text-center text-gray-500 flex items-center justify-center h-full">
            <span>No forensic reports found matching your filters.</span>
          </div>
        ) : (
          <table className="w-full border-collapse text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-gray-200">
                <th className="p-3 text-left font-semibold text-gray-700 w-[160px]">Report ID</th>
                <th className="p-3 text-left font-semibold text-gray-700">Title</th>
                <th className="p-3 text-center font-semibold text-gray-700 w-[100px]">Severity</th>
                <th className="p-3 text-center font-semibold text-gray-700 w-[100px]">Status</th>
                <th className="p-3 text-center font-semibold text-gray-700 w-[120px]">Detected</th>
                <th className="p-3 text-center font-semibold text-gray-700 w-[120px]">Signature</th>
                <th className="p-3 text-center font-semibold text-gray-700 w-[120px]">Actions</th>
              </tr>
            </thead>

            <tbody>
              {filteredAndSortedReports.map((report) => (
                <tr key={report.id} className={`border-b ${expandedRowId === report.id ? 'bg-gray-50' : ''} hover:bg-gray-50`}>
                  <td className="p-3 text-xs text-blue-600 font-semibold font-mono" onClick={() => onSelectReport(report.id)}>
                    {report.id.substring(0, 12)}...
                  </td>
                  <td className="p-3 font-medium text-gray-900" onClick={() => onSelectReport(report.id)}>{report.title}</td>
                  <td className="p-3 text-center">
                    <span className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${getSeverityClass(report.severity)}`}>{getSeverityLabel(report.severity)}</span>
                  </td>
                  <td className="p-3 text-center">
                    <span className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${getStatusClass(report.status)}`}>{getStatusLabel(report.status)}</span>
                  </td>
                  <td className="p-3 text-center text-gray-500">{formatDate(report.detectedAt).split(',')[0]}</td>
                  <td className="p-3 text-center">{getVerificationBadge(report.signatureValid)}</td>
                  <td className="p-3 text-center flex items-center justify-center gap-2">
                    <button onClick={() => onSelectReport(report.id)} className="px-3 py-1 bg-blue-600 text-white rounded text-sm font-semibold" title="View report details">View</button>
                    {onDownloadReport && (
                      <button onClick={() => onDownloadReport(report.id)} className="px-3 py-1 bg-emerald-600 text-white rounded text-sm font-semibold" title="Download PDF">↓ PDF</button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* ===================================================================== */}
      {/* SUMMARY */}
      {/* ===================================================================== */}

      <div className="p-3 bg-gray-100 rounded text-sm text-gray-500 flex justify-between">
        <span>Showing {filteredAndSortedReports.length} of {reports.length} reports</span>
        <span>Verified: {reports.filter((r) => r.signatureValid).length} ✓</span>
      </div>
    </div>
  );
};

export default ForensicReportList;
