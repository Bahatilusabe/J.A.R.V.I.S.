name: CI (with optional Fabric integration)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          pip install pytest
      - name: Run unit tests
        run: python3 -m pytest backend/tests/unit -q

  fabric-integration:
    name: Fabric integration (optional)
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        include:
          - name: fabric-integration
    if: ${{ always() }}
    env:
      RUN_FABRIC_INTEGRATION: '1'
      FABRIC_NET_PROFILE: ${{ secrets.FABRIC_NET_PROFILE }}
      FABRIC_ORG: ${{ secrets.FABRIC_ORG }}
      FABRIC_USER: ${{ secrets.FABRIC_USER }}
      FABRIC_CHANNEL: ${{ secrets.FABRIC_CHANNEL }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies (Fabric SDK)
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          # The Fabric Python SDK may be heavy and require system packages.
          # This placeholder demonstrates intent: in a real CI you must
          # pre-install Fabric SDK dependencies or use a prepared runner.
          pip install hfc cryptography || true
      - name: Fabric network setup (placeholder)
        run: |
          echo "This step should prepare a Fabric test network and place a connection profile at $FABRIC_NET_PROFILE"
          echo "In CI, replace this with steps that bring up the test network (docker-compose, test-network scripts, etc.)"
      - name: Run Fabric integration tests
        run: python3 -m pytest backend/tests/integration -q || true
